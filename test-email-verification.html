<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邮箱验证码测试</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        input, button { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #00b899; color: white; border: none; cursor: pointer; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>邮箱验证码功能测试</h1>
    
    <div class="section">
        <h2>1. 发送验证码</h2>
        <input type="email" id="emailInput" placeholder="输入邮箱地址" style="width: 300px;">
        <button onclick="sendCode()" id="sendBtn">发送验证码</button>
        <div id="sendResult"></div>
    </div>

    <div class="section">
        <h2>2. 验证验证码</h2>
        <input type="email" id="verifyEmailInput" placeholder="邮箱地址" style="width: 200px;">
        <input type="text" id="codeInput" placeholder="6位验证码" maxlength="6" style="width: 100px;">
        <button onclick="verifyCode()" id="verifyBtn">验证</button>
        <div id="verifyResult"></div>
    </div>

    <div class="section">
        <h2>3. 完成注册</h2>
        <input type="email" id="registerEmailInput" placeholder="邮箱地址" style="width: 200px;"><br>
        <input type="text" id="registerCodeInput" placeholder="6位验证码" maxlength="6" style="width: 100px;">
        <input type="password" id="passwordInput" placeholder="密码" style="width: 150px;"><br>
        <button onclick="register()" id="registerBtn">注册</button>
        <div id="registerResult"></div>
    </div>

    <script>
        async function sendCode() {
            const email = document.getElementById('emailInput').value;
            const resultDiv = document.getElementById('sendResult');
            const btn = document.getElementById('sendBtn');
            
            if (!email) {
                resultDiv.innerHTML = '<div class="error">请输入邮箱地址</div>';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '发送中...';
            
            try {
                const response = await fetch('/api/email-verification/send-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = result.message;
                    if (result.devOTP) {
                        message += `<br><strong>开发模式验证码：${result.devOTP}</strong>`;
                    }
                    resultDiv.innerHTML = `<div class="success">${message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">错误：${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">网络错误：${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = '发送验证码';
            }
        }
        
        async function verifyCode() {
            const email = document.getElementById('verifyEmailInput').value;
            const code = document.getElementById('codeInput').value;
            const resultDiv = document.getElementById('verifyResult');
            
            if (!email || !code) {
                resultDiv.innerHTML = '<div class="error">请输入邮箱和验证码</div>';
                return;
            }
            
            try {
                const response = await fetch('/api/email-verification/verify-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `<div class="success">${result.message}</div>`;
                } else {
                    let message = result.error;
                    if (result.attemptsLeft) {
                        message += ` (剩余尝试次数：${result.attemptsLeft})`;
                    }
                    resultDiv.innerHTML = `<div class="error">错误：${message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">网络错误：${error.message}</div>`;
            }
        }
        
        async function register() {
            const email = document.getElementById('registerEmailInput').value;
            const code = document.getElementById('registerCodeInput').value;
            const password = document.getElementById('passwordInput').value;
            const resultDiv = document.getElementById('registerResult');
            const btn = document.getElementById('registerBtn');
            
            if (!email || !code || !password) {
                resultDiv.innerHTML = '<div class="error">请填写所有字段</div>';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '注册中...';
            
            try {
                const response = await fetch('/api/email-verification/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `<div class="success">
                        ${result.message}<br>
                        用户ID: ${result.data.user.id}<br>
                        邮箱: ${result.data.user.email}<br>
                        Token已生成
                    </div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">错误：${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">网络错误：${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = '注册';
            }
        }
    </script>
</body>
</html>