'use client'

import { useState, useEffect } from 'react'
import { X } from 'lucide-react'
import { AdminCompany, CreateCompanyData, UpdateCompanyData, COMPANY_TYPE_OPTIONS } from '@/lib/types/admin'
// ÁßªÈô§ÊóßÁöÑÂØºÂÖ•ÔºåÊîπÁî®APIË∞ÉÁî®
import { LanguageTabs, LanguageField } from '@/components/admin/forms/language-tabs'
import { ImageUpload } from '@/components/admin/forms/image-upload'
import { AdminCountry, AdminProvince, AdminDevelopmentZone } from '@/lib/types/admin'

interface CompanyFormProps {
  company?: AdminCompany | null
  onSuccess: () => void
  onCancel: () => void
}

export function CompanyForm({ company, onSuccess, onCancel }: CompanyFormProps) {
  const [formData, setFormData] = useState({
    name_zh: '',
    name_en: '',
    logo_url: '',
    address_zh: '',
    address_en: '',
    company_type: 'private' as const,
    country_id: '',
    province_id: '',
    development_zone_id: '',
    industry_code: '',
    annual_output_value: '',
    contact_person: '',
    contact_phone: '',
    contact_email: '',
    is_active: true
  })
  
  const [countries, setCountries] = useState<AdminCountry[]>([])
  const [provinces, setProvinces] = useState<AdminProvince[]>([])
  const [developmentZones, setDevelopmentZones] = useState<AdminDevelopmentZone[]>([])
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [errors, setErrors] = useState<Record<string, string>>({})

  useEffect(() => {
    loadCountries()
    
    if (company) {
      setFormData({
        name_zh: company.name_zh,
        name_en: company.name_en || '',
        logo_url: company.logo_url || '',
        address_zh: company.address_zh || '',
        address_en: company.address_en || '',
        company_type: company.company_type || 'private',
        country_id: company.country_id || '',
        province_id: company.province_id || '',
        development_zone_id: company.development_zone_id || '',
        industry_code: company.industry_code || '',
        annual_output_value: company.annual_output_value?.toString() || '',
        contact_person: company.contact_person || '',
        contact_phone: company.contact_phone || '',
        contact_email: company.contact_email || '',
        is_active: company.is_active
      })

      // Â¶ÇÊûúÊúâÂõΩÂÆ∂ÔºåÂä†ËΩΩÁúÅ‰ªΩ
      if (company.country_id) {
        loadProvinces(company.country_id)
      }
      
      // Â¶ÇÊûúÊúâÁúÅ‰ªΩÔºåÂä†ËΩΩÁªèÂºÄÂå∫
      if (company.province_id) {
        loadDevelopmentZones(company.province_id)
      }
    }
  }, [company])

  const loadCountries = async () => {
    try {
      const response = await fetch('/api/admin/countries')
      if (response.ok) {
        const data = await response.json()
        // Á°Æ‰øùÊï∞ÊçÆÊòØÊï∞ÁªÑÊ†ºÂºè
        setCountries(Array.isArray(data) ? data : [])
      } else {
        setCountries([])
      }
    } catch (error) {
      console.error('Âä†ËΩΩÂõΩÂÆ∂ÂàóË°®Â§±Ë¥•:', error)
      setCountries([])
    }
  }

  const loadProvinces = async (countryId: string) => {
    try {
      // Âè™ÊúâÈÄâÊã©‰∏≠ÂõΩÊó∂ÊâçÂä†ËΩΩÁúÅ‰ªΩÊï∞ÊçÆ
      console.log('üîç ÂºÄÂßãÂä†ËΩΩÁúÅ‰ªΩÊï∞ÊçÆÔºåÂõΩÂÆ∂ID:', countryId)
      const response = await fetch(`/api/admin/provinces?countryId=${countryId}`)
      console.log('ÁúÅ‰ªΩAPIÂìçÂ∫îÁä∂ÊÄÅ:', response.status)
      
      if (response.ok) {
        const result = await response.json()
        console.log('ÁúÅ‰ªΩAPIËøîÂõûÊï∞ÊçÆ:', result)
        // APIËøîÂõûÊ†ºÂºèÊòØ { success: true, data: [...] }
        const data = result.success ? result.data : []
        console.log('Â§ÑÁêÜÂêéÁöÑÁúÅ‰ªΩÊï∞ÊçÆ:', data)
        setProvinces(Array.isArray(data) ? data : [])
      } else {
        console.log('ÁúÅ‰ªΩAPIËØ∑Ê±ÇÂ§±Ë¥•')
        setProvinces([])
      }
    } catch (error) {
      console.error('Âä†ËΩΩÁúÅ‰ªΩÂàóË°®Â§±Ë¥•:', error)
      setProvinces([])
    }
  }

  const loadDevelopmentZones = async (provinceId: string) => {
    try {
      // Ê†πÊçÆÁúÅ‰ªΩIDÂä†ËΩΩÁªèÂºÄÂå∫Êï∞ÊçÆ
      console.log('üîç ÂºÄÂßãÂä†ËΩΩÁªèÂºÄÂå∫Êï∞ÊçÆÔºåÁúÅ‰ªΩID:', provinceId)
      const response = await fetch(`/api/admin/development-zones?provinceId=${provinceId}`)
      console.log('ÁªèÂºÄÂå∫APIÂìçÂ∫îÁä∂ÊÄÅ:', response.status)
      
      if (response.ok) {
        const result = await response.json()
        console.log('ÁªèÂºÄÂå∫APIËøîÂõûÊï∞ÊçÆ:', result)
        // APIËøîÂõûÊ†ºÂºèÊòØ { success: true, data: [...] }
        const data = result.success ? result.data : []
        console.log('Â§ÑÁêÜÂêéÁöÑÁªèÂºÄÂå∫Êï∞ÊçÆ:', data)
        setDevelopmentZones(Array.isArray(data) ? data : [])
      } else {
        console.log('ÁªèÂºÄÂå∫APIËØ∑Ê±ÇÂ§±Ë¥•')
        setDevelopmentZones([])
      }
    } catch (error) {
      console.error('Âä†ËΩΩÁªèÂºÄÂå∫ÂàóË°®Â§±Ë¥•:', error)
      setDevelopmentZones([])
    }
  }

  const handleCountryChange = (countryId: string) => {
    setFormData(prev => ({
      ...prev,
      country_id: countryId,
      province_id: '',
      development_zone_id: ''
    }))
    setProvinces([])
    setDevelopmentZones([])
    
    // Âè™ÊúâÈÄâÊã©‰∏≠ÂõΩÊó∂ÊâçÂä†ËΩΩÁúÅ‰ªΩÊï∞ÊçÆ
    if (countryId && Array.isArray(countries)) {
      const selectedCountry = countries.find(c => c.id === countryId)
      if (selectedCountry && selectedCountry.code === 'china') {
        loadProvinces(countryId)
      }
    }
  }

  const handleProvinceChange = (provinceId: string) => {
    setFormData(prev => ({
      ...prev,
      province_id: provinceId,
      development_zone_id: ''
    }))
    setDevelopmentZones([])
    
    if (provinceId) {
      loadDevelopmentZones(provinceId)
    }
  }

  const validateForm = (): boolean => {
    const newErrors: Record<string, string> = {}

    // È™åËØÅ‰ºÅ‰∏öÂêçÁß∞
    if (!formData.name_zh.trim()) {
      newErrors.name_zh = '‰ºÅ‰∏ö‰∏≠ÊñáÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫'
    }

    // È™åËØÅËÅîÁ≥ªÁîµËØùÊ†ºÂºè
    if (formData.contact_phone && !/^1[3-9]\d{9}$/.test(formData.contact_phone)) {
      newErrors.contact_phone = 'ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÊâãÊú∫Âè∑Á†Å'
    }

    // È™åËØÅÈÇÆÁÆ±Ê†ºÂºè
    if (formData.contact_email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.contact_email)) {
      newErrors.contact_email = 'ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÈÇÆÁÆ±Âú∞ÂùÄ'
    }

    // È™åËØÅÂπ¥‰∫ßÂÄº
    if (formData.annual_output_value && isNaN(Number(formData.annual_output_value))) {
      newErrors.annual_output_value = 'Âπ¥‰∫ßÂÄºÂøÖÈ°ª‰∏∫Êï∞Â≠ó'
    }

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    if (isSubmitting) return

    const isValid = validateForm()
    if (!isValid) return

    try {
      setIsSubmitting(true)

      const submitData = {
        name_zh: formData.name_zh.trim(),
        name_en: formData.name_en.trim() || undefined,
        logo_url: formData.logo_url || undefined,
        address_zh: formData.address_zh.trim() || undefined,
        address_en: formData.address_en.trim() || undefined,
        company_type: formData.company_type,
        country_id: formData.country_id || undefined,
        province_id: formData.province_id || undefined,
        development_zone_id: formData.development_zone_id === 'none' ? undefined : (formData.development_zone_id || undefined),
        industry_code: formData.industry_code.trim() || undefined,
        annual_output_value: formData.annual_output_value ? Number(formData.annual_output_value) : undefined,
        contact_person: formData.contact_person.trim() || undefined,
        contact_phone: formData.contact_phone.trim() || undefined,
        contact_email: formData.contact_email.trim() || undefined,
        is_active: formData.is_active
      }

      if (company) {
        // Êõ¥Êñ∞‰ºÅ‰∏ö
        const response = await fetch(`/api/admin/companies/${company.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(submitData),
        })

        if (!response.ok) {
          const errorData = await response.json()
          throw new Error(errorData.error || 'Êõ¥Êñ∞Â§±Ë¥•')
        }
      } else {
        // ÂàõÂª∫‰ºÅ‰∏ö
        const response = await fetch('/api/admin/companies', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(submitData),
        })

        if (!response.ok) {
          const errorData = await response.json()
          throw new Error(errorData.error || 'ÂàõÂª∫Â§±Ë¥•')
        }
      }

      onSuccess()
    } catch (error) {
      console.error('‰øùÂ≠ò‰ºÅ‰∏öÂ§±Ë¥•:', error)
      alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï')
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        {/* Â§¥ÈÉ® */}
        <div className="flex items-center justify-between p-6 border-b border-gray-200">
          <h2 className="text-xl font-semibold text-gray-900">
            {company ? 'ÁºñËæë‰ºÅ‰∏ö' : 'Êñ∞Â¢û‰ºÅ‰∏ö'}
          </h2>
          <button
            onClick={onCancel}
            className="p-1 hover:bg-gray-100 rounded"
          >
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* Ë°®Âçï */}
        <form onSubmit={handleSubmit} className="p-6 space-y-6">
          {/* Âü∫Êú¨‰ø°ÊÅØ */}
          <div>
            <h3 className="text-lg font-medium text-gray-900 mb-4">Âü∫Êú¨‰ø°ÊÅØ</h3>
            
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Logo‰∏ä‰º† */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ‰ºÅ‰∏öLogo
                </label>
                <ImageUpload
                  value={formData.logo_url}
                  onChange={(url) => setFormData(prev => ({ ...prev, logo_url: url }))}
                  placeholder="‰∏ä‰º†‰ºÅ‰∏öLogo"
                  maxSize={2}
                />
              </div>

              {/* ‰ºÅ‰∏öÂêçÁß∞ */}
              <div className="lg:col-span-2">
                <LanguageTabs>
                  {(language) => (
                    <LanguageField
                      label={language === 'zh' ? '‰ºÅ‰∏ö‰∏≠ÊñáÂêçÁß∞' : '‰ºÅ‰∏öËã±ÊñáÂêçÁß∞'}
                      value={language === 'zh' ? formData.name_zh : formData.name_en}
                      onChange={(value) => setFormData(prev => ({ 
                        ...prev, 
                        [language === 'zh' ? 'name_zh' : 'name_en']: value 
                      }))}
                      placeholder={language === 'zh' ? '‰æãÂ¶ÇÔºöÁªøËâ≤ÁßëÊäÄÊúâÈôêÂÖ¨Âè∏' : 'e.g. Green Technology Co., Ltd.'}
                      required={language === 'zh'}
                      error={language === 'zh' ? errors.name_zh : undefined}
                    />
                  )}
                </LanguageTabs>
              </div>
            </div>
          </div>

          {/* ‰ºÅ‰∏öÊÄßË¥®ÂíåÂú∞ÁêÜ‰ΩçÁΩÆ */}
          <div>
            <h3 className="text-lg font-medium text-gray-900 mb-4">‰ºÅ‰∏öÊÄßË¥®‰∏éÂú∞ÁêÜ‰ΩçÁΩÆ</h3>
            
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              {/* ‰ºÅ‰∏öÊÄßË¥® */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  ‰ºÅ‰∏öÊÄßË¥®
                </label>
                <select
                  value={formData.company_type}
                  onChange={(e) => setFormData(prev => ({ ...prev, company_type: e.target.value as any }))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                >
                  {COMPANY_TYPE_OPTIONS.map(option => (
                    <option key={option.value} value={option.value}>
                      {option.label_zh}
                    </option>
                  ))}
                </select>
              </div>

              {/* ÂõΩÂà´ */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  ÂõΩÂà´
                </label>
                <select
                  value={formData.country_id}
                  onChange={(e) => handleCountryChange(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                >
                  <option value="">ËØ∑ÈÄâÊã©ÂõΩÂà´</option>
                  {Array.isArray(countries) && countries.map(country => (
                    <option key={country.id} value={country.id}>
                      {country.name_zh}
                    </option>
                  ))}
                </select>
              </div>

              {/* ÁúÅ‰ªΩ */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  ÁúÅ‰ªΩ
                </label>
                <select
                  value={formData.province_id}
                  onChange={(e) => handleProvinceChange(e.target.value)}
                  disabled={!formData.country_id || (Array.isArray(countries) && countries.find(c => c.id === formData.country_id)?.code !== 'china')}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent disabled:bg-gray-100"
                >
                  <option value="">
                    {Array.isArray(countries) && countries.find(c => c.id === formData.country_id)?.code === 'china' ? 'ËØ∑ÈÄâÊã©ÁúÅ‰ªΩ' : '‰ªÖÈôê‰∏≠ÂõΩ‰ºÅ‰∏öÈÄâÊã©ÁúÅ‰ªΩ'}
                  </option>
                  {Array.isArray(provinces) && provinces.map(province => (
                    <option key={province.id} value={province.id}>
                      {province.name_zh}
                    </option>
                  ))}
                </select>
              </div>

              {/* ÁªèÂºÄÂå∫ */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  ÂõΩÂÆ∂Á∫ßÁªèÂºÄÂå∫
                </label>
                <select
                  value={formData.development_zone_id}
                  onChange={(e) => setFormData(prev => ({ ...prev, development_zone_id: e.target.value }))}
                  disabled={!formData.province_id || (Array.isArray(countries) && countries.find(c => c.id === formData.country_id)?.code !== 'china')}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent disabled:bg-gray-100"
                >
                  <option value="">ËØ∑ÈÄâÊã©ÁªèÂºÄÂå∫</option>
                  <option value="none">‰∏çÂú®ÂõΩÂÆ∂Á∫ßÁªèÂºÄÂå∫ÂÜÖ</option>
                  {Array.isArray(developmentZones) && developmentZones.map(zone => (
                    <option key={zone.id} value={zone.id}>
                      {zone.name_zh}
                    </option>
                  ))}
                </select>
              </div>
            </div>
          </div>

          {/* Âú∞ÂùÄ‰ø°ÊÅØ */}
          <div>
            <h3 className="text-lg font-medium text-gray-900 mb-4">Âú∞ÂùÄ‰ø°ÊÅØ</h3>
            
            <LanguageTabs>
              {(language) => (
                <LanguageField
                  label={language === 'zh' ? '‰∏≠ÊñáÂú∞ÂùÄ' : 'Ëã±ÊñáÂú∞ÂùÄ'}
                  value={language === 'zh' ? formData.address_zh : formData.address_en}
                  onChange={(value) => setFormData(prev => ({ 
                    ...prev, 
                    [language === 'zh' ? 'address_zh' : 'address_en']: value 
                  }))}
                  placeholder={language === 'zh' ? '‰æãÂ¶ÇÔºöÂåó‰∫¨Â∏ÇÊúùÈò≥Âå∫ÊüêÊüêË°óÈÅì123Âè∑' : 'e.g. No.123, XX Street, Chaoyang District, Beijing'}
                  type="textarea"
                  rows={2}
                />
              )}
            </LanguageTabs>
          </div>

          {/* ‰ºÅ‰∏öËØ¶ÊÉÖ */}
          <div>
            <h3 className="text-lg font-medium text-gray-900 mb-4">‰ºÅ‰∏öËØ¶ÊÉÖ</h3>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Ë°å‰∏ö‰ª£Á†Å
                </label>
                <input
                  type="text"
                  value={formData.industry_code}
                  onChange={(e) => setFormData(prev => ({ ...prev, industry_code: e.target.value }))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                  placeholder="‰æãÂ¶ÇÔºöC38"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Â∑•‰∏öÊÄª‰∫ßÂÄºÔºà‰∫øÂÖÉÔºâ
                </label>
                <input
                  type="number"
                  step="0.1"
                  value={formData.annual_output_value}
                  onChange={(e) => setFormData(prev => ({ ...prev, annual_output_value: e.target.value }))}
                  className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent ${
                    errors.annual_output_value ? 'border-red-300' : 'border-gray-300'
                  }`}
                  placeholder="‰æãÂ¶ÇÔºö15.6"
                />
                {errors.annual_output_value && (
                  <p className="text-red-500 text-sm mt-1">{errors.annual_output_value}</p>
                )}
              </div>
            </div>
          </div>

          {/* ËÅîÁ≥ª‰ø°ÊÅØ */}
          <div>
            <h3 className="text-lg font-medium text-gray-900 mb-4">ËÅîÁ≥ª‰ø°ÊÅØ</h3>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  ËÅîÁ≥ª‰∫∫
                </label>
                <input
                  type="text"
                  value={formData.contact_person}
                  onChange={(e) => setFormData(prev => ({ ...prev, contact_person: e.target.value }))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                  placeholder="‰æãÂ¶ÇÔºöÂº†‰∏â"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  ËÅîÁ≥ªÁîµËØù
                </label>
                <input
                  type="tel"
                  value={formData.contact_phone}
                  onChange={(e) => setFormData(prev => ({ ...prev, contact_phone: e.target.value }))}
                  className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent ${
                    errors.contact_phone ? 'border-red-300' : 'border-gray-300'
                  }`}
                  placeholder="‰æãÂ¶ÇÔºö13800138000"
                />
                {errors.contact_phone && (
                  <p className="text-red-500 text-sm mt-1">{errors.contact_phone}</p>
                )}
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  ËÅîÁ≥ªÈÇÆÁÆ±
                </label>
                <input
                  type="email"
                  value={formData.contact_email}
                  onChange={(e) => setFormData(prev => ({ ...prev, contact_email: e.target.value }))}
                  className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent ${
                    errors.contact_email ? 'border-red-300' : 'border-gray-300'
                  }`}
                  placeholder="‰æãÂ¶ÇÔºöcontact@company.com"
                />
                {errors.contact_email && (
                  <p className="text-red-500 text-sm mt-1">{errors.contact_email}</p>
                )}
              </div>
            </div>
          </div>

          {/* Áä∂ÊÄÅ */}
          <div>
            <div className="flex items-center">
              <input
                type="checkbox"
                id="is_active"
                checked={formData.is_active}
                onChange={(e) => setFormData(prev => ({ ...prev, is_active: e.target.checked }))}
                className="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500"
              />
              <label htmlFor="is_active" className="ml-2 text-sm text-gray-700">
                ÂêØÁî®Áä∂ÊÄÅ
              </label>
            </div>
          </div>

          {/* ÊåâÈíÆ */}
          <div className="flex justify-end space-x-3 pt-6 border-t border-gray-200">
            <button
              type="button"
              onClick={onCancel}
              className="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
            >
              ÂèñÊ∂à
            </button>
            <button
              type="submit"
              disabled={isSubmitting}
              className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {isSubmitting ? '‰øùÂ≠ò‰∏≠...' : '‰øùÂ≠ò'}
            </button>
          </div>
        </form>
      </div>
    </div>
  )
}