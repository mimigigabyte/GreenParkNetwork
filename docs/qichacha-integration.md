# 企查查API集成文档

## 功能概述

本项目已集成企查查企业模糊搜索API（接口编号886），为用户在完善企业信息时提供智能自动补全功能。

## 功能特性

### 1. 企业信息自动补全
- 用户输入企业名称时，系统自动调用企查查API搜索匹配的企业
- 返回最多5条企业信息供用户选择
- 支持通过企业名、人名、产品名、地址、电话、经营范围等关键词搜索

### 2. 自动填充功能
选择企业后系统将自动填充：
- **企业名称**：选中的企业完整名称
- **联系人**：法定代表人姓名
- **详细地址**：企业注册地址
- **统一社会信用代码**：自动保存到数据库（不显示给用户）

### 3. 数据来源
- 企业名称
- 法定代表人
- 企业状态（存续/在业等）
- 成立日期
- 统一社会信用代码
- 注册号
- 注册地址

## 技术实现

### 后端API结构
```
/api/company/search?q=搜索关键词
```

### 前端组件
- `CompanySearch`: 企业搜索自动补全组件
- 集成在 `company-profile` 页面的企业名称输入框

### 数据库字段
在 `admin_companies` 表中添加了 `credit_code` 字段用于存储统一社会信用代码。

## 配置说明

### 环境变量
在 `.env.local` 文件中配置：
```bash
# 企查查API配置
QICHACHA_API_KEY=875C77BDF7DD41D1ED30647417275AA6
```

### 数据库迁移
运行以下脚本执行数据库迁移：
```bash
node scripts/setup-qichacha-integration.js
```

或手动在Supabase SQL编辑器中执行：
```sql
ALTER TABLE admin_companies ADD COLUMN credit_code VARCHAR(50);
COMMENT ON COLUMN admin_companies.credit_code IS '统一社会信用代码';
CREATE INDEX idx_admin_companies_credit_code ON admin_companies(credit_code);
```

## 用户体验

### 搜索流程
1. 用户在企业信息页面输入企业名称
2. 系统在用户停止输入500ms后自动发起搜索请求
3. 显示匹配的企业列表（最多5条）
4. 用户点击选择目标企业
5. 系统自动填充相关信息

### 界面特性
- **防抖搜索**：避免频繁API调用
- **加载状态**：搜索时显示加载动画
- **错误处理**：网络错误时显示友好提示
- **企业状态**：用颜色标识企业状态（存续为绿色）
- **信息完整性**：显示法定代表人和注册地址

## API响应示例

```json
{
  "success": true,
  "data": [
    {
      "id": "企业主键",
      "name": "企业名称",
      "creditCode": "统一社会信用代码",
      "legalRepresentative": "法定代表人",
      "registeredDate": "2012-07-10",
      "status": "存续",
      "registrationNumber": "注册号",
      "address": "注册地址"
    }
  ],
  "total": 1
}
```

## 错误处理

### 常见错误码
- `400`: 搜索关键字为空或少于2个字符
- `500`: 企查查API调用失败
- 网络错误: 显示"网络错误，请稍后重试"

### 调试信息
- 所有API调用错误都会在浏览器控制台输出详细日志
- 服务端错误会记录在服务器日志中

## 安全考虑

1. **API密钥保护**: 企查查API密钥仅在服务端使用，不暴露给前端
2. **请求频率**: 实现了防抖机制，避免过度调用API
3. **数据验证**: 对所有输入进行验证和清理
4. **错误屏蔽**: 不向用户暴露内部错误详情

## 维护说明

### 监控指标
- API调用成功率
- 响应时间
- 错误率统计

### 更新流程
1. 更新环境变量配置
2. 运行数据库迁移
3. 重启应用服务

### 故障排除
1. 检查API密钥是否正确配置
2. 验证网络连接到企查查API服务
3. 确认数据库字段已正确创建
4. 查看服务器和浏览器控制台错误日志