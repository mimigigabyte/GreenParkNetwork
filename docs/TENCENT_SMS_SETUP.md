# 腾讯云短信验证码服务配置指南

本指南将帮助您配置腾讯云短信服务，实现手机短信验证码发送功能。

## 📋 前提条件

1. 拥有腾讯云账户
2. 完成腾讯云实名认证
3. 开通短信服务
4. 申请短信签名和模板

## 🚀 腾讯云控制台配置

### 1. 开通短信服务

1. 登录 [腾讯云控制台](https://console.cloud.tencent.com/)
2. 搜索并进入 "短信 SMS" 服务
3. 点击 "免费开通"
4. 完成服务开通

### 2. 获取API密钥

1. 进入 [访问管理控制台](https://console.cloud.tencent.com/cam/capi)
2. 在左侧菜单选择 "访问密钥" > "API密钥管理"
3. 点击 "新建密钥" 创建API密钥对
4. 记录 `SecretId` 和 `SecretKey`

⚠️ **安全提醒**: API密钥具有账户完全访问权限，请妥善保管，不要泄露。

### 3. 创建短信应用

1. 在短信控制台，选择 "应用管理" > "应用列表"
2. 点击 "创建应用"
3. 填写应用信息：
   - **应用名称**: 例如 "绿色技术平台"
   - **应用简介**: 应用描述
4. 创建成功后，记录 `SDK AppID`

### 4. 申请短信签名

1. 选择 "国内短信" > "签名管理"
2. 点击 "创建签名"
3. 填写签名信息：
   - **签名用途**: 验证码类
   - **签名类型**: 网站
   - **签名内容**: 例如 "绿色技术平台"
   - **证明类型**: 提供相关资质证明
4. 提交审核（通常1-2个工作日）

### 5. 申请短信模板

1. 选择 "国内短信" > "正文模板管理"
2. 点击 "创建正文模板"
3. 填写模板信息：
   - **模板名称**: 验证码模板
   - **短信类型**: 验证码
   - **短信内容**: `您的验证码是{1}，{2}分钟内有效，请勿泄露给他人。`
4. 提交审核（通常1-2个工作日）

模板变量说明：
- `{1}`: 验证码（6位数字）
- `{2}`: 有效时间（分钟）

## 🔧 项目配置

### 1. 环境变量配置

在 `.env.local` 文件中添加以下配置：

```bash
# 腾讯云短信配置
NEXT_PUBLIC_USE_TENCENT_SMS=true
JWT_SECRET=your-jwt-secret-key-change-in-production

# 腾讯云API密钥
TENCENT_SECRET_ID=your_secret_id_here
TENCENT_SECRET_KEY=your_secret_key_here
TENCENT_SMS_REGION=ap-beijing
TENCENT_SMS_SDK_APP_ID=your_sdk_app_id_here
TENCENT_SMS_SIGN_NAME=绿色技术平台
TENCENT_SMS_TEMPLATE_ID=your_template_id_here
```

### 2. 配置项说明

| 配置项 | 说明 | 示例值 |
|--------|------|--------|
| `NEXT_PUBLIC_USE_TENCENT_SMS` | 启用腾讯云短信服务 | `true` |
| `JWT_SECRET` | JWT加密密钥 | `your-jwt-secret-key` |
| `TENCENT_SECRET_ID` | 腾讯云API密钥ID | `AKID***************` |
| `TENCENT_SECRET_KEY` | 腾讯云API密钥Key | `**********************` |
| `TENCENT_SMS_REGION` | 地域参数 | `ap-beijing` |
| `TENCENT_SMS_SDK_APP_ID` | 短信应用ID | `1400***123` |
| `TENCENT_SMS_SIGN_NAME` | 短信签名内容 | `绿色技术平台` |
| `TENCENT_SMS_TEMPLATE_ID` | 短信模板ID | `123456` |

## 🗄️ 数据库配置

系统会自动创建短信验证码存储表，如果需要手动创建，请执行：

```sql
-- 运行数据库迁移
-- 位置: supabase/migrations/006_create_sms_verification_codes.sql
```

## 🧪 测试验证

### 1. 开发环境测试

开发环境下，即使没有正确配置腾讯云密钥，系统也会生成验证码并在控制台显示：

```bash
npm run dev
```

打开浏览器控制台，查看验证码输出信息。

### 2. 功能测试步骤

1. **访问登录页面**
   - 点击 "手机验证码登录"
   
2. **输入手机号**
   - 输入有效的11位手机号码
   
3. **发送验证码**
   - 点击 "获取验证码"
   - 查看控制台日志或手机短信
   
4. **验证登录**
   - 输入收到的验证码
   - 点击 "登录"

### 3. API测试

使用curl测试API接口：

```bash
# 发送验证码
curl -X POST http://localhost:3000/api/auth/send-sms-code \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "purpose": "login",
    "countryCode": "+86"
  }'

# 验证码登录
curl -X POST http://localhost:3000/api/auth/login-sms-code \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "code": "123456",
    "countryCode": "+86"
  }'
```

## 🐛 常见问题

### 1. 短信发送失败

**错误**: `InvalidParameter.TemplateNotMatch`
- **原因**: 模板参数不匹配
- **解决**: 检查模板ID和参数格式是否正确

**错误**: `UnauthorizedOperation`
- **原因**: API密钥权限不足
- **解决**: 检查密钥是否正确，是否具有短信服务权限

### 2. 验证码验证失败

**错误**: 验证码不存在或已过期
- **原因**: 验证码存储或查询问题
- **解决**: 检查数据库连接和表结构

### 3. 频率限制

**错误**: 发送过于频繁
- **原因**: 触发频率限制（60秒内只能发送一次）
- **解决**: 等待60秒后重试

## 📊 监控和日志

### 1. 腾讯云控制台监控

- **发送统计**: 查看短信发送成功率和失败原因
- **用量统计**: 监控短信使用量和费用
- **回执分析**: 查看短信到达率

### 2. 应用日志

系统会记录以下日志信息：
- 验证码生成和发送结果
- 验证码验证尝试
- 用户登录成功/失败

## 💰 费用说明

腾讯云短信按量计费：
- **国内短信**: 约0.045元/条
- **免费额度**: 新用户通常有100条免费短信
- **套餐包**: 可购买短信包降低单价

## 🔒 安全建议

1. **API密钥安全**
   - 不要将API密钥提交到代码仓库
   - 定期轮换API密钥
   - 使用子账号和最小权限原则

2. **验证码安全**
   - 设置合理的过期时间（5分钟）
   - 限制验证尝试次数（最多5次）
   - 实施频率限制（60秒间隔）

3. **业务安全**
   - 验证手机号格式
   - 防止恶意刷短信
   - 记录异常行为日志

## 📞 支持

如果遇到问题：
1. 查看腾讯云短信控制台的错误日志
2. 检查应用服务器日志
3. 参考 [腾讯云短信API文档](https://cloud.tencent.com/document/product/382)
4. 联系腾讯云技术支持

---

配置完成后，您的应用就可以使用腾讯云短信服务发送验证码了！🎉